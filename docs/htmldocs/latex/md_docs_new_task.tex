\label{md_docs_new_task_new_task}%
\Hypertarget{md_docs_new_task_new_task}%


This page provides a tutorial for creating a new task, and adding it to the {\ttfamily controller} runtime.\hypertarget{md_docs_new_task_autotoc_md7}{}\doxysection{Introduction to tasks}\label{md_docs_new_task_autotoc_md7}
Tasks represent the basic building block of the {\ttfamily controller} program. For a brief overview of the overall structure of the program, please read the \mbox{\hyperlink{index_design}{Design}} section first.

In short, tasks work with frame data. Sensors create frame data from external sources, Ptasks create processed frame data from other frame data and Sinks output frame data to external sources. Frame data is stored in the {\ttfamily \mbox{\hyperlink{struct_pdata}{Pdata}}} data structure.\hypertarget{md_docs_new_task_autotoc_md8}{}\doxysection{A basic task}\label{md_docs_new_task_autotoc_md8}
A basic example of frame data is \mbox{\hyperlink{struct_pdata_aff718bd1adfc60db9b04e78a142a6e40}{Pdata\+::camera\+\_\+image}} which represents the image seen by the camera in the current frame. A basic example of a \mbox{\hyperlink{class_ptask}{Ptask}} would be one which takes the camera image and converts it to grayscale, storing it in a new Pdata\+::grayscale\+\_\+image slot.\hypertarget{md_docs_new_task_autotoc_md9}{}\doxysubsection{Creating the class}\label{md_docs_new_task_autotoc_md9}
Firstly, decide on the name for your task class. Let us call our {\ttfamily Grayscale}. Create a directory in the appropriate place\+: ptasks go in {\ttfamily src/ptasks} so we create {\ttfamily src/ptasks/grayscale} (sinks go in {\ttfamily src/iotasks/sinks} and sensors go in {\ttfamily src/iotasks/sensor}). All the files related to this class go in this directory\+:


\begin{DoxyItemize}
\item {\ttfamily src/ptasks/grayscale/grayscale.\+h} -\/ Class definition
\item {\ttfamily src/ptasks/grayscale/grayscale.\+cpp} -\/ Class implementation
\item {\ttfamily src/ptasks/grayscale/pdata.\+inc} -\/ \mbox{\hyperlink{struct_pdata}{Pdata}} generated (not present for Sinks)
\item {\ttfamily src/ptasks/grayscale/options.\+inc} -\/ \mbox{\hyperlink{struct_options}{Options}} used (optional)
\item {\ttfamily src/ptasks/grayscale/static\+\_\+options.\+inc} -\/ \mbox{\hyperlink{struct_static_options}{Static\+Options}} used (optional)
\end{DoxyItemize}

\begin{DoxyNote}{Note}
{\ttfamily .h} and {\ttfamily .cpp} files MUST be added to {\ttfamily CMake\+Lists.\+txt}
\end{DoxyNote}
A simple implementation of the Grayscale class would look as follows\+:

{\ttfamily src/ptasks/grayscale/grayscale.\+h}\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{///}
\DoxyCodeLine{/// \(\backslash\)file grayscale.h}
\DoxyCodeLine{/// \(\backslash\)brief Grayscale class.}
\DoxyCodeLine{}
\DoxyCodeLine{\#ifndef PTASKS\_GRAYSCALE\_H}
\DoxyCodeLine{\#define PTASKS\_GRAYSCALE\_H}
\DoxyCodeLine{}
\DoxyCodeLine{\#include <ptasks/ptask.h>}
\DoxyCodeLine{}
\DoxyCodeLine{///}
\DoxyCodeLine{/// \(\backslash\)brief Create grayscale image.}
\DoxyCodeLine{class Grayscale final : public Ptask \{}
\DoxyCodeLine{public:}
\DoxyCodeLine{    Grayscale();}
\DoxyCodeLine{    void compute(Pdata*, const Options*) final;}
\DoxyCodeLine{\};}
\DoxyCodeLine{}
\DoxyCodeLine{\#endif}

\end{DoxyCode}


{\ttfamily src/ptasks/grayscale/grayscale.\+cpp}\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{\#include <ptasks/grayscale/grayscale.h>}
\DoxyCodeLine{}
\DoxyCodeLine{\#include <opencv2/opencv.hpp>}
\DoxyCodeLine{}
\DoxyCodeLine{Grayscale::Grayscale()}
\DoxyCodeLine{    // Name of the task and a unique key for the terminal log interface.}
\DoxyCodeLine{    : Ptask("{}Grayscale"{}, 'g')}
\DoxyCodeLine{\{\}}
\DoxyCodeLine{}
\DoxyCodeLine{void Grayscale::compute(Pdata *pdata, const Options *options)}
\DoxyCodeLine{\{}
\DoxyCodeLine{    // This function gets called by the system for every frame.}
\DoxyCodeLine{    }
\DoxyCodeLine{    (void) options; // unused}
\DoxyCodeLine{    }
\DoxyCodeLine{    cv::cvtColor(pdata-\/>camera\_image, pdata-\/>grayscale\_image, CV\_BGR2GRAY);}
\DoxyCodeLine{\}}

\end{DoxyCode}


\begin{DoxyNote}{Note}
{\ttfamily generate\+\_\+options.\+py} relies on {\ttfamily \mbox{\hyperlink{struct_pdata}{Pdata}} $\ast$} and {\ttfamily \mbox{\hyperlink{struct_options}{Options}} $\ast$} variables being named {\ttfamily pdata} and {\ttfamily options}, so please keep that convention.
\end{DoxyNote}
{\ttfamily src/ptasks/grayscale/pdata.\+inc}\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{///}
\DoxyCodeLine{/// \(\backslash\)brief Grayscaled version of the camera image.}
\DoxyCodeLine{cv::Mat grayscale\_image;}

\end{DoxyCode}
\hypertarget{md_docs_new_task_autotoc_md10}{}\doxysubsection{Adding the task to the list of tasks to be executed}\label{md_docs_new_task_autotoc_md10}
The final step is to add the task to the list of tasks being executed. To do this, you must modify the {\ttfamily sched.\+cpp} file first add the import to the header file at the beginning of the file\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{\#include <ptasks/grayscale/grayscale.cpp>}

\end{DoxyCode}


Then, search for the {\ttfamily ADD TASKS HERE} section. Add the following code\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{ptasks\_L1.push\_back(new Grayscale());}

\end{DoxyCode}
\hypertarget{md_docs_new_task_autotoc_md11}{}\doxysubsection{Using options}\label{md_docs_new_task_autotoc_md11}
One of {\ttfamily controller}\textquotesingle{}s unique features are the hot-\/swappable \mbox{\hyperlink{struct_options}{Options}} parameters, which allow changing the functionality of the program on-\/the-\/fly from the web interface. This is generally used in place of magic constants for algorithms. To use options, you must include an {\ttfamily options.\+inc} file in the class directory. This file is similar to the {\ttfamily pdata.\+inc} file with the exception that elements declared here must have a default value.

Excerpt from {\ttfamily src/ptasks/lane\+\_\+detection/options.\+inc}\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{std::uint8\_t lane\_detection\_blur\_level = 3;}
\DoxyCodeLine{}
\DoxyCodeLine{short lane\_detection\_canny\_thresh\_low = 50;}
\DoxyCodeLine{short lane\_detection\_canny\_thresh\_high = 150;}

\end{DoxyCode}


In code, you will be able to access these options via the {\ttfamily const Options$\ast$} argument as {\ttfamily options-\/\texorpdfstring{$>$}{>}\mbox{[}option\+\_\+name\mbox{]}}\hypertarget{md_docs_new_task_autotoc_md12}{}\doxysubsection{Using static\+\_\+options}\label{md_docs_new_task_autotoc_md12}
These are compile-\/time constants which can not be changed on the fly. To use them declare a file {\ttfamily static\+\_\+options.\+inc}. This file is similar to an {\ttfamily options.\+inc} file.

In code, you will be able to access these options as {\ttfamily \mbox{\hyperlink{struct_static_options}{Static\+Options}}\+:\+:\mbox{[}option name\mbox{]}}.

\begin{DoxyNote}{Note}
Use hot-\/swappable options instead of static ones whenever you can! Generally, everything not needed at class initialization time should be a hot-\/swappable option.
\end{DoxyNote}
\hypertarget{md_docs_new_task_autotoc_md13}{}\doxysubsection{Logging}\label{md_docs_new_task_autotoc_md13}
The \mbox{\hyperlink{class_ptask}{Ptask}}, \mbox{\hyperlink{class_sink}{Sink}} and \mbox{\hyperlink{class_sensor}{Sensor}} classes inherit from the \mbox{\hyperlink{class_loggable}{Loggable}} class, which provides protected functions for logging. To log to the screen, write something like this in your class code\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{log(LogLevel::INFO, "{}Hello, logs!"{});}

\end{DoxyCode}


You are encouraged to read the documentation for the \mbox{\hyperlink{class_loggable}{Loggable}} which provides important information on logs, including the real-\/time watch feature.\hypertarget{md_docs_new_task_autotoc_md14}{}\doxysubsection{Creating a sink or a sensor}\label{md_docs_new_task_autotoc_md14}
The only difference between creating a \mbox{\hyperlink{class_ptask}{Ptask}} as opposed to a \mbox{\hyperlink{class_sink}{Sink}} or a \mbox{\hyperlink{class_sensor}{Sensor}} (Sinks and Sensors are {\ttfamily \mbox{\hyperlink{class_i_otask}{IOtask}}}s) is the name of the main function you should override. As shown above, the function in \mbox{\hyperlink{class_ptask}{Ptask}} is\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{void compute(Pdata*, const Options*);}

\end{DoxyCode}


In \mbox{\hyperlink{class_i_otask}{IOtask}}, the function is


\begin{DoxyCode}{0}
\DoxyCodeLine{void compute\_frame();}

\end{DoxyCode}


and {\ttfamily pdata} and {\ttfamily options} are available as protected members of the base class, but otherwise the functionality is the same. 