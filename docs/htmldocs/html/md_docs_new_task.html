<!-- HTML header for doxygen 1.9.4-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.4"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>controller: Creating a new task</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript">
    DoxygenAwesomeDarkModeToggle.init()
</script>
<script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript">
    DoxygenAwesomeFragmentCopyButton.init()
</script>
<script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
<script type="text/javascript">
    DoxygenAwesomeParagraphLink.init()
</script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">controller
   </div>
   <div id="projectbrief">controller project</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.4 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_docs_new_task.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Creating a new task </div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#autotoc_md7">Introduction to tasks</a></li>
<li class="level1"><a href="#autotoc_md8">A basic task</a><ul><li class="level2"><a href="#autotoc_md9">Creating the class</a></li>
<li class="level2"><a href="#autotoc_md10">Adding the task to the list of tasks to be executed</a></li>
<li class="level2"><a href="#autotoc_md11">Using options</a></li>
<li class="level2"><a href="#autotoc_md12">Using static_options</a></li>
<li class="level2"><a href="#autotoc_md13">Logging</a></li>
<li class="level2"><a href="#autotoc_md14">Creating a sink or a sensor</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><p ><a class="anchor" id="new_task"></a></p>
<p >This page provides a tutorial for creating a new task, and adding it to the <code>controller</code> runtime.</p>
<h1><a class="anchor" id="autotoc_md7"></a>
Introduction to tasks</h1>
<p >Tasks represent the basic building block of the <code>controller</code> program. For a brief overview of the overall structure of the program, please read the <a class="el" href="index.html#design">Design</a> section first.</p>
<p >In short, tasks work with frame data. Sensors create frame data from external sources, Ptasks create processed frame data from other frame data and Sinks output frame data to external sources. Frame data is stored in the <code><a class="el" href="struct_pdata.html" title="Frame data.">Pdata</a></code> data structure.</p>
<h1><a class="anchor" id="autotoc_md8"></a>
A basic task</h1>
<p >A basic example of frame data is <a class="el" href="struct_pdata.html#aff718bd1adfc60db9b04e78a142a6e40" title="camera image">Pdata::camera_image</a> which represents the image seen by the camera in the current frame. A basic example of a <a class="el" href="class_ptask.html">Ptask</a> would be one which takes the camera image and converts it to grayscale, storing it in a new Pdata::grayscale_image slot.</p>
<h2><a class="anchor" id="autotoc_md9"></a>
Creating the class</h2>
<p >Firstly, decide on the name for your task class. Let us call our <code>Grayscale</code>. Create a directory in the appropriate place: ptasks go in <code>src/ptasks</code> so we create <code>src/ptasks/grayscale</code> (sinks go in <code>src/iotasks/sinks</code> and sensors go in <code>src/iotasks/sensor</code>). All the files related to this class go in this directory:</p>
<ul>
<li><code>src/ptasks/grayscale/grayscale.h</code> - Class definition</li>
<li><code>src/ptasks/grayscale/grayscale.cpp</code> - Class implementation</li>
<li><code>src/ptasks/grayscale/pdata.inc</code> - <a class="el" href="struct_pdata.html" title="Frame data.">Pdata</a> generated (not present for Sinks)</li>
<li><code>src/ptasks/grayscale/options.inc</code> - <a class="el" href="struct_options.html" title="Hot swappable-options.">Options</a> used (optional)</li>
<li><code>src/ptasks/grayscale/static_options.inc</code> - <a class="el" href="struct_static_options.html" title="Compilation constants.">StaticOptions</a> used (optional)</li>
</ul>
<dl class="section note"><dt>Note</dt><dd><code>.h</code> and <code>.cpp</code> files MUST be added to <code>CMakeLists.txt</code></dd></dl>
<p>A simple implementation of the Grayscale class would look as follows:</p>
<p ><code>src/ptasks/grayscale/grayscale.h</code>:</p>
<div class="fragment"><div class="line">///</div>
<div class="line">/// \file grayscale.h</div>
<div class="line">/// \brief Grayscale class.</div>
<div class="line"> </div>
<div class="line">#ifndef PTASKS_GRAYSCALE_H</div>
<div class="line">#define PTASKS_GRAYSCALE_H</div>
<div class="line"> </div>
<div class="line">#include &lt;ptasks/ptask.h&gt;</div>
<div class="line"> </div>
<div class="line">///</div>
<div class="line">/// \brief Create grayscale image.</div>
<div class="line">class Grayscale final : public Ptask {</div>
<div class="line">public:</div>
<div class="line">    Grayscale();</div>
<div class="line">    void compute(Pdata*, const Options*) final;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line">#endif</div>
</div><!-- fragment --><p ><code>src/ptasks/grayscale/grayscale.cpp</code>:</p>
<div class="fragment"><div class="line">#include &lt;ptasks/grayscale/grayscale.h&gt;</div>
<div class="line"> </div>
<div class="line">#include &lt;opencv2/opencv.hpp&gt;</div>
<div class="line"> </div>
<div class="line">Grayscale::Grayscale()</div>
<div class="line">    // Name of the task and a unique key for the terminal log interface.</div>
<div class="line">    : Ptask(&quot;Grayscale&quot;, &#39;g&#39;)</div>
<div class="line">{}</div>
<div class="line"> </div>
<div class="line">void Grayscale::compute(Pdata *pdata, const Options *options)</div>
<div class="line">{</div>
<div class="line">    // This function gets called by the system for every frame.</div>
<div class="line">    </div>
<div class="line">    (void) options; // unused</div>
<div class="line">    </div>
<div class="line">    cv::cvtColor(pdata-&gt;camera_image, pdata-&gt;grayscale_image, CV_BGR2GRAY);</div>
<div class="line">}</div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd><code>generate_options.py</code> relies on <code><a class="el" href="struct_pdata.html" title="Frame data.">Pdata</a> *</code> and <code><a class="el" href="struct_options.html" title="Hot swappable-options.">Options</a> *</code> variables being named <code>pdata</code> and <code>options</code>, so please keep that convention.</dd></dl>
<p><code>src/ptasks/grayscale/pdata.inc</code>:</p>
<div class="fragment"><div class="line">///</div>
<div class="line">/// \brief Grayscaled version of the camera image.</div>
<div class="line">cv::Mat grayscale_image;</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md10"></a>
Adding the task to the list of tasks to be executed</h2>
<p >The final step is to add the task to the list of tasks being executed. To do this, you must modify the <code>sched.cpp</code> file first add the import to the header file at the beginning of the file:</p>
<div class="fragment"><div class="line">#include &lt;ptasks/grayscale/grayscale.cpp&gt;</div>
</div><!-- fragment --><p >Then, search for the <code>ADD TASKS HERE</code> section. Add the following code:</p>
<div class="fragment"><div class="line">ptasks_L1.push_back(new Grayscale());</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md11"></a>
Using options</h2>
<p >One of <code>controller</code>'s unique features are the hot-swappable <a class="el" href="struct_options.html" title="Hot swappable-options.">Options</a> parameters, which allow changing the functionality of the program on-the-fly from the web interface. This is generally used in place of magic constants for algorithms. To use options, you must include an <code>options.inc</code> file in the class directory. This file is similar to the <code>pdata.inc</code> file with the exception that elements declared here must have a default value.</p>
<p >Excerpt from <code>src/ptasks/lane_detection/options.inc</code>:</p>
<div class="fragment"><div class="line">std::uint8_t lane_detection_blur_level = 3;</div>
<div class="line"> </div>
<div class="line">short lane_detection_canny_thresh_low = 50;</div>
<div class="line">short lane_detection_canny_thresh_high = 150;</div>
</div><!-- fragment --><p >In code, you will be able to access these options via the <code>const Options*</code> argument as <code>options-&gt;[option_name]</code></p>
<h2><a class="anchor" id="autotoc_md12"></a>
Using static_options</h2>
<p >These are compile-time constants which can not be changed on the fly. To use them declare a file <code>static_options.inc</code>. This file is similar to an <code>options.inc</code> file.</p>
<p >In code, you will be able to access these options as <code><a class="el" href="struct_static_options.html" title="Compilation constants.">StaticOptions</a>::[option name]</code>.</p>
<dl class="section note"><dt>Note</dt><dd>Use hot-swappable options instead of static ones whenever you can! Generally, everything not needed at class initialization time should be a hot-swappable option.</dd></dl>
<h2><a class="anchor" id="autotoc_md13"></a>
Logging</h2>
<p >The <a class="el" href="class_ptask.html">Ptask</a>, <a class="el" href="class_sink.html" title="Base class for output tasks.">Sink</a> and <a class="el" href="class_sensor.html" title="Base class for input tasks.">Sensor</a> classes inherit from the <a class="el" href="class_loggable.html" title="Base class for logging classes.">Loggable</a> class, which provides protected functions for logging. To log to the screen, write something like this in your class code:</p>
<div class="fragment"><div class="line">log(LogLevel::INFO, &quot;Hello, logs!&quot;);</div>
</div><!-- fragment --><p >You are encouraged to read the documentation for the <a class="el" href="class_loggable.html" title="Base class for logging classes.">Loggable</a> which provides important information on logs, including the real-time watch feature.</p>
<h2><a class="anchor" id="autotoc_md14"></a>
Creating a sink or a sensor</h2>
<p >The only difference between creating a <a class="el" href="class_ptask.html">Ptask</a> as opposed to a <a class="el" href="class_sink.html" title="Base class for output tasks.">Sink</a> or a <a class="el" href="class_sensor.html" title="Base class for input tasks.">Sensor</a> (Sinks and Sensors are <code><a class="el" href="class_i_otask.html" title="Base class for input/output tasks.">IOtask</a></code>s) is the name of the main function you should override. As shown above, the function in <a class="el" href="class_ptask.html">Ptask</a> is:</p>
<div class="fragment"><div class="line">void compute(Pdata*, const Options*);</div>
</div><!-- fragment --><p >In <a class="el" href="class_i_otask.html" title="Base class for input/output tasks.">IOtask</a>, the function is</p>
<div class="fragment"><div class="line">void compute_frame();</div>
</div><!-- fragment --><p >and <code>pdata</code> and <code>options</code> are available as protected members of the base class, but otherwise the functionality is the same. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.4 </li>
  </ul>
</div>
</body>
</html>
